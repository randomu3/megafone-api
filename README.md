# Megafon SMS API для Bitrix

Улучшенный класс для работы с HTTP API Megafon для отправки и получения SMS с интеграцией в Bitrix Framework.

## Особенности

- ✅ Массовая отправка SMS (одинаковое сообщение на множество номеров)
- ✅ Индивидуальная отправка SMS (разные сообщения разным получателям)
- ✅ Система опций с кешированием настроек
- ✅ Полное логирование всех операций
- ✅ Поддержка языковых файлов
- ✅ Режим отладки

- ✅ Обработка callback уведомлений
- ✅ Интеграция с ORM Bitrix
- ✅ Админка для настройки модуля

## Установка

1. Скопируйте файлы в соответствующие папки вашего модуля
2. Настройте параметры в админке Bitrix или через COption
3. Создайте таблицу для логирования (если используете SmsLogTable)

## Настройки модуля

Настройки хранятся в опциях модуля `sng.megafon`:

- `login` - Логин для авторизации в API Megafon
- `password` - Пароль для авторизации
- `originator` - Имя отправителя по умолчанию (до 11 символов)
- `callback_url` - URL для получения callback уведомлений
- `gap` - Интервал между отправкой SMS в миллисекундах (по умолчанию 1000)
- `debug` - Включить режим отладки (Y/N)
- `log` - Включить логирование операций (Y/N)
- `cache_options` - Кешировать настройки модуля (Y/N)

## Использование

### Инициализация

```php
use Sng\Core\MegafonAPI;

// Использование настроек из модуля
$oApi = new MegafonAPI();

// Или с явным указанием логина и пароля
$oApi = new MegafonAPI('your_login', 'your_password');
```

### Отправка одного SMS

```php
$arResult = $oApi->sendSMS(
    "TestSender",           // Имя отправителя
    "79261238212",          // Номер получателя
    "Привет!",              // Текст сообщения
    "http://site.com/cb",   // Callback URL (опционально)
    "custom_msg_id"         // Пользовательский ID (опционально)
);

if ($arResult['success']) {
    echo "SMS отправлено, ID: " . $arResult['msg_id'];
} else {
    echo "Ошибка: " . $arResult['error'];
}
```

### Массовая отправка

```php
$arPhones = ["79261238212", "79261238213", "79261238214"];
$arResult = $oApi->sendBulkSms("Массовое сообщение", $arPhones);

echo "Отправлено: " . $arResult['total_sent'];
echo "Ошибок: " . $arResult['total_failed'];

// Детальная информация по каждому номеру
foreach ($arResult['results'] as $result) {
    echo $result['phone'] . ": " . ($result['success'] ? "OK" : $result['error']);
}
```

### Индивидуальная отправка

```php
$arMessages = [
    ['phone' => '79261238212', 'message' => 'Персональное сообщение 1'],
    ['phone' => '79261238213', 'message' => 'Персональное сообщение 2'],
    ['phone' => '79261238214', 'message' => 'Персональное сообщение 3']
];

$arResult = $oApi->sendIndividualSms($arMessages);
```



### Обработка callback уведомлений

Создайте файл `megafon_callback.php` (пример включен) и укажите его URL в настройках callback_url.

## Дополнительные опции

При отправке можно передать дополнительные опции:

```php
$arOptions = [
    'from' => 'CustomSender',
    'callback_url' => 'https://yourdomain.com/callback.php',
    'msg_id' => 'custom_id_' . time()
];

$arResult = $oApi->sendBulkSms("Сообщение", $arPhones, $arOptions);
```

## Логирование

Все операции логируются в таблицу `SmsLogTable` (если включено логирование):

- Отправка SMS
- Получение баланса
- Проверка статуса
- Обработка callback'ов

## Коды ошибок

Класс содержит полный справочник кодов ошибок Megafon API с описаниями на русском языке. Описания также доступны через языковые файлы.

## Кеширование

Настройки модуля кешируются для повышения производительности. Кеш автоматически очищается при изменении настроек в админке.

## Требования

- Bitrix Framework
- PHP 7.0+
- Модуль должен быть зарегистрирован в системе
- Настроенная таблица для логирования (опционально)

## Структура файлов

```
/
├── MegafonAPI.php              # Основной класс
├── megafon_callback.php        # Обработчик callback'ов
├── admin_options.php           # Админка модуля
├── example_usage.php           # Примеры использования
├── lang/ru/
│   ├── MegafonAPI.php         # Языковой файл для класса
│   └── admin_options.php      # Языковой файл для админки
└── README.md                   # Документация
```

## Миграция с старой версии

Если у вас была старая версия класса MegafonAPI, новая версия полностью совместима. Добавлены новые методы:

- `sendBulkSms()` - массовая отправка
- `sendIndividualSms()` - индивидуальная отправка  
- `getErrorText()` - получение описания ошибок

Старый метод `sendSMS()` работает без изменений.